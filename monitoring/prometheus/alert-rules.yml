groups:
  - name: debtflow-alerts
    rules:
      - alert: HighApiLatency
        expr: histogram_quantile(0.95, sum(rate(django_http_requests_latency_seconds_by_view_method_bucket[5m])) by (le)) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API P95 latency > 500ms for 5 minutes"
          description: "Investigate slow queries, check DB connection pool"

      - alert: HighErrorRate
        expr: sum(rate(django_http_responses_total_by_status_view_method{status=~"5.."}[3m])) / sum(rate(django_http_responses_total_by_status_view_method[3m])) > 0.05
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "5xx error rate > 5% for 3 minutes"
          description: "Page on-call, check logs and recent deploys"

      - alert: DatabaseConnectionsHigh
        expr: pg_stat_activity_count / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Database connections > 80% of max"
          description: "Check PgBouncer, look for connection leaks"

      - alert: CeleryQueueBacklog
        expr: celery_queue_length > 1000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Celery queue depth > 1000 for 10 minutes"
          description: "Scale workers, check for stuck tasks"

      - alert: SFTPImportFailed
        expr: increase(debtflow_sftp_import_records_total{status="failed"}[15m]) > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "SFTP import job failed"
          description: "Check error_details, contact client if file corrupted"

      - alert: PaymentProcessorDown
        expr: debtflow_circuit_breaker_state{name="stripe"} == 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Payment processor circuit breaker is OPEN"
          description: "Check Stripe status page, hold new payments"

      - alert: PodCrashLooping
        expr: increase(kube_pod_container_status_restarts_total{namespace="debtflow"}[10m]) > 3
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Pod restarted > 3 times in 10 minutes"
          description: "Check pod logs, OOM kills, config errors"

      - alert: DiskUsageHigh
        expr: kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PVC usage > 85%"
          description: "Cleanup old data, expand volume, archive"
