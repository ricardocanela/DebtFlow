apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-vacuum
spec:
  schedule: "0 3 * * 0"  # Sunday 3 AM
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: vacuum
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
              command: ["python", "-c", "import django; django.setup(); from tasks.maintenance import vacuum_tables; vacuum_tables()"]
              envFrom:
                - configMapRef:
                    name: {{ .Release.Name }}-config
                - secretRef:
                    name: {{ .Release.Name }}-secret
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-audit-cleanup
spec:
  schedule: "0 2 1 * *"  # 1st of month, 2 AM
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: audit-cleanup
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
              command: ["python", "-c", "import django; django.setup(); from tasks.maintenance import archive_audit_logs; archive_audit_logs()"]
              envFrom:
                - configMapRef:
                    name: {{ .Release.Name }}-config
                - secretRef:
                    name: {{ .Release.Name }}-secret
